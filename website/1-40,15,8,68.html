<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title></title>
<style>
  :root { --pad: 14px; --radius: 14px; }
  body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; line-height: 1.5; margin: 0; background: #0b1020; color: #e6e7ef; }
  .container { max-width: 1600px; margin: 28px auto; padding: 0 16px; }
  h1 { font-size: 24px; margin: 0 0 20px; }
  .card { background: #121733; border: 1px solid #24306b; border-radius: var(--radius); box-shadow: 0 8px 24px rgba(0,0,0,0.25); padding: var(--pad); margin-bottom: 20px; }
  .section-title { font-size: 18px; margin: 0 0 12px; }
  .grid { display: grid; gap: 12px; }
  .grid-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
  .grid-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
  label { display: block; font-weight: 600; margin-bottom: 6px; }
  input[type="number"], select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #2a356f; background: #0f1430; color: #e6e7ef; font-size: 14px; }
  .btn { display: inline-block; padding: 12px 16px; background: #5b6cff; color: white; border: 0; border-radius: 12px; font-weight: 700; cursor: pointer; }
  .btn:disabled { opacity: 0.6; cursor: not-allowed; }
  .muted { color: #9aa0c7; font-size: 13px; }
  .result { display: grid; gap: 8px; }
  .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; background: #1b2351; color: #aab2ff; font-weight: 700; font-size: 12px; }
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 8px; border-bottom: 1px solid #2a356f; vertical-align: top; }
  th { text-align: left; background: #151c40; }
  .center { text-align: center; }
  .slider-row input[type="range"]{ display: grid; grid-template-columns: 220px 1fr 100px; gap: 12px; align-items: center;width: 100%; }
  input[type="range"] { width: 100%; }
  .hidden { display: none; }
  .small { font-size: 12px; color: #9aa0c7; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  .badge { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#1e254f; border:1px solid #2b3572; font-size:12px; color:#d8dbff }
  .ok { color:#00d98b }
  .warn { color:#ffcc66 }
  .bad { color:#ff6b6b }

  /* Four-column layout */
  .main-layout { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 24px; }

  .barWrap { background:#0f1430; border:1px solid #2a356f; border-radius:10px; overflow:hidden; }
  .bar { height: 22px; transition: width 0.3s ease; }
</style>
</head>
<body>
  <div class="container">

    <div class="main-layout">

      <!-- ===== Column 1: Form ===== -->
      <div>
        <div class="card">
          <h2 class="section-title">กรอกข้อมูลเบื้องต้น</h2>
          <form id="mainForm" autocomplete="off">
            <div class="grid grid-3">
              <div>
                <label for="sex">เพศ</label>
                <select id="sex" required>
                  <option value="">— เลือก —</option>
                  <option value="ชาย">ชาย</option>
                  <option value="หญิง">หญิง</option>
                </select>
                <div class="small">เข้ารหัส: ชาย=0, หญิง=1</div>
              </div>
              <div>
                <label for="height">ส่วนสูง (ซม.)</label>
                <input id="height" type="number" min="120" max="210" step="0.1" required />
              </div>
              <div>
                <label for="weight">น้ำหนัก (กก.)</label>
                <input id="weight" type="number" min="25" max="140" step="0.1" required />
              </div>
              <div style="grid-column: span 3;">
                <label>ระดับกิจกรรม (active_intensity)</label>
                <div>
                  <label><input type="radio" name="activeIntensity" value="0" required> 0: อยู่กับที่</label><br>
                  <label><input type="radio" name="activeIntensity" value="1"> 1: ออกกำลังเล็กน้อย</label><br>
                  <label><input type="radio" name="activeIntensity" value="2"> 2: ปานกลาง</label><br>
                  <label><input type="radio" name="activeIntensity" value="3"> 3: หนัก</label><br>
                  <label><input type="radio" name="activeIntensity" value="4"> 4: หนักมาก</label>
                </div>
              </div>
            </div>

            <div class="grid grid-2" style="margin-top:12px;">
              <div>
                <label for="sleepDays">นอนครบ 8 ชม. กี่วัน/สัปดาห์</label>
                <input id="sleepDays" type="number" min="0" max="7" step="1" required />
              </div>
              <div>
                <label for="sleepHours">วันที่ไม่นอนพอ นอนกี่ชั่วโมง</label>
                <input id="sleepHours" type="number" min="0" max="12" step="0.5" required />
              </div>
            </div>

            <button type="submit" class="btn" style="margin-top:12px;">คำนวณผลลัพธ์</button>
          </form>
        </div>

        <!-- Sleep-only adjustment slider -->
        <div id="adjustCard" class="card hidden">
          <h2 class="section-title">ปรับเวลานอนต่อสัปดาห์</h2>
          <div class="slider-row">
            <div><strong>Sleep per Week</strong> (0–84 ชม.)</div>
            <input id="adjSleep" type="range" min="0" max="84" step="1" />
            <div class="mono" id="adjSleepVal">—</div>
          </div>
        </div>
      </div>

      <!-- ===== Column 2: Sumw Questionnaire ===== -->
      <div>
        <div class="card">
          <h3 class="section-title">แบบสอบถามการบริโภค (sumw)</h3>
          <p class="muted">0 = แทบไม่ทำ, 1 = 3–4 ครั้ง/สัปดาห์, 2 = ทุกวัน/เกือบทุกวัน</p>
          <table>
            <thead>
              <tr>
                <th>พฤติกรรม</th>
                <th class="center">0</th>
                <th class="center">1</th>
                <th class="center">2</th>
              </tr>
            </thead>
            <tbody id="sumwBody"></tbody>
          </table>
        </div>
      </div>

      <!-- ===== Column 3: Results ===== -->
      <div>
        <div class="card">
          <h3 class="section-title">ผลลัพธ์</h3>
          <div class="result" style="margin-bottom:10px;">
            <div>
              <span class="pill">WHO BMI</span>
              <span id="bmiText" class="mono"></span>
            </div>
            <div>
              <span class="pill">Model Prediction</span>
              <span id="predLabel" class="mono"></span>
            </div>
          </div>

          <h4 style="margin:6px 0;">ความน่าจะเป็นของแต่ละคลาส</h4>
          <div id="probBars"></div>

          <h4 style="margin:12px 0;">Normalized Values</h4>
          <table id="normTable">
            <thead>
              <tr><th>Feature</th><th>Raw</th><th>Z-score</th></tr>
            </thead>
            <tbody id="normBody"></tbody>
          </table>
        </div>
      </div>

      <!-- ===== Column 4: Suggestions ===== -->
      <div>
        <div id="suggestCard" class="card hidden">
          <h3 class="section-title">ค่าด้านพฤติกรรมที่เเนะนำ</h3>
          <div id="suggestNote" class="small"></div>
          <table>
            <thead>
              <tr>
                <th>Feature</th>
                <th>Current</th>
                <th>Suggested</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>active_intensity</td><td id="curAI">-</td><td id="sugAI">-</td></tr>
              <tr><td>sleep_per_week</td><td id="curSleep">-</td><td id="sugSleep">-</td></tr>
              <tr><td>sumw</td><td id="curSumw">-</td><td id="sugSumw">-</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
    const labels = ["Underweight", "Normal", "Overweight"];
    const sexMap = { "ชาย": 0, "หญิง": 1 };
    const model = {
      features: ["sex", "active_intensity", "sleep_per_week", "sumw"],
      bias: [-0.1574794857540424, 1.250065445020538, -1.0925859592664957],
      coef: [
        [0.2353687510964586, 0.5209538299285625, -0.1205335769260536, -1.9814307497629315],
        [-0.3870985267088993, 0.21279414193662236, 0.22442793554731485, 0.3114658268318084],
        [0.1517297756124411, -0.7337479718651844, -0.09610564137873819, 1.6699649229311229]
      ],
      mean: {
        active_intensity: 3.005,
        sleep_per_week: 46.62,
        sumw: 14.92
      },
      std: {
        active_intensity: 0.885988,
        sleep_per_week: 6.630656,
        sumw: 6.329581
      }
    };
  
    const sumwQuestions = [
      "1 เครื่องดื่มหวาน (เติมน้ำตาล)",
      "2 น้ำอัดลม/กาแฟ 3in1/ชูกำลัง",
      "3 น้ำผัก/ผลไม้สำเร็จรูป",
      "4 ไอศกรีม/เบเกอรี่/ขนมหวานไทย",
      "5 เติมน้ำตาล/น้ำผึ้ง/น้ำเชื่อม",
      "6 เลือกเนื้อสัตว์ติดมัน/หนัง",
      "7 อาหารทอด/ฟาสต์ฟู้ด/กึ่งสำเร็จรูป",
      "8 จานเดียวไขมันสูง/แกงกะทิ",
      "9 เครื่องดื่มผสมนม/นมข้น/ครีมเทียม",
      "10 ซดน้ำผัด/น้ำแกง หรือราดลงข้าว",
      "11 ปรุงอาหารจัด ไม่ชิม",
      "12 ขนมโซเดียมสูง",
      "13 เนื้อสัตว์แปรรูป/ปลาเค็ม/ปลาร้า",
      "14 บะหมี่/โจ๊กกึ่งสำเร็จรูป/อาหารแช่แข็ง",
      "15 ผักผลไม้ดอง/ผลไม้แช่อิ่ม"
    ];
  
    function qs(sel) { return document.querySelector(sel); }
    function qsa(sel) { return Array.from(document.querySelectorAll(sel)); }
  
    function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }
    function normalize(value, key) {
      if (!(key in model.mean)) return value;
      const mu = model.mean[key];
      const sd = model.std[key];
      if (sd === 0) return 0;
      return (value - mu) / sd;
    }
    function toRawFromZ(z, key) {
      const mu = model.mean[key];
      const sd = model.std[key];
      return mu + sd * z;
    }
    function dot(a, b) { let s = 0; for (let i = 0; i < a.length; i++) s += a[i] * b[i]; return s; }
    function softmax(z) {
      const m = Math.max(...z);
      const exps = z.map(v => Math.exp(v - m));
      const s = exps.reduce((a, b) => a + b, 0);
      return exps.map(v => v / s);
    }
  
    function sleepPerWeekFrom(day, hours){
  const d = clamp(Number(day),0,7);
  const h = clamp(Number(hours),0,12);
  const sleepHoursPerWeek = (d * 8) + ((7 - d) * h);
  return sleepHoursPerWeek;
}
  
    function predict(state) {
      const sexNum = sexMap[state.sex];
      const aiZ = normalize(state.active_intensity, 'active_intensity');
      const slZ = normalize(state.sleep_per_week, 'sleep_per_week');
      const swZ = normalize(state.sumw, 'sumw');
      const x = [sexNum, aiZ, slZ, swZ];
      const scores = model.coef.map((coefRow, i) => model.bias[i] + dot(coefRow, x));
      const probs = softmax(scores);
      const argmax = probs.indexOf(Math.max(...probs));
      return { label: labels[argmax], probs, z: { aiZ, slZ, swZ }, x };
    }
  
    function searchEqualDelta(state, target = 0.7) {
      const sexNum = sexMap[state.sex];
      const base = {
        aiZ: normalize(state.active_intensity, 'active_intensity'),
        slZ: normalize(state.sleep_per_week, 'sleep_per_week'),
        swZ: normalize(state.sumw, 'sumw')
      };
      function pNormalFor(delta) {
        const x = [
          sexNum,
          base.aiZ + delta,
          base.slZ + delta,
          base.swZ + delta
        ];
        const scores = model.coef.map((coefRow, i) => model.bias[i] + dot(coefRow, x));
        const probs = softmax(scores);
        return probs[1]; // index 1 = Normal
      }
      const maxDelta = 5.0; // search up to ±5 SD
      const step = 0.01;
      if (pNormalFor(0) >= target) return { ok: true, delta: 0 };
      for (let a = step; a <= maxDelta + 1e-9; a += step) {
        const pPlus = pNormalFor(+a);
        const pMinus = pNormalFor(-a);
        if (pPlus >= target) return { ok: true, delta: +a };
        if (pMinus >= target) return { ok: true, delta: -a };
      }
      return { ok: false };
    }
  
    function bmiAndClass(weightKg, heightCm) {
      const h = Number(heightCm) / 100;
      const bmi = weightKg / (h * h);
      let cls = '';
      if (bmi < 18.5) cls = 'Underweight';
      else if (bmi < 25) cls = 'Normal';
      else cls = 'Overweight';
      return { bmi, cls };
    }
  
    const form = qs('#mainForm');
    const sumwBody = qs('#sumwBody');
    const adjustCard = qs('#adjustCard');
    const adjSleep = qs('#adjSleep');
    const adjSleepVal = qs('#adjSleepVal');
  
    const predLabelEl = qs('#predLabel');
    const bmiTextEl = qs('#bmiText');
    const probBarsEl = qs('#probBars');
    const normBody = qs('#normBody');
  
    const suggestCard = qs('#suggestCard');
    const currentSnapshot = qs('#currentSnapshot');
    const suggestTbody = qs('#suggestTbody');
    const suggestNote = qs('#suggestNote');
    const curAI = qs('#curAI');
    const curSleep = qs('#curSleep');
    const curSumw = qs('#curSumw');
    const sugAI = qs('#sugAI');
    const sugSleep = qs('#sugSleep');
    const sugSumw = qs('#sugSumw');
  
    let state = null; // working state after first submit
  
    function generateSumwTable() {
      sumwBody.innerHTML = '';
      sumwQuestions.forEach((q, i) => {
        const tr = document.createElement('tr');
        const tdQ = document.createElement('td');
        tdQ.textContent = q;
        tr.appendChild(tdQ);
        for (let v = 0; v <= 2; v++) {
          const td = document.createElement('td');
          td.className = 'center';
          const radio = document.createElement('input');
          radio.type = 'radio'; radio.name = `sumw_${i + 1}`; radio.value = String(v); radio.required = true;
          td.appendChild(radio);
          tr.appendChild(td);
        }
        sumwBody.appendChild(tr);
      });
    }
  
    function readSumw() {
      let total = 0; let count = 0;
      for (let i = 1; i <= 15; i++) {
        const picked = qs(`input[name="sumw_${i}"]:checked`);
        if (!picked) return null;
        total += parseInt(picked.value, 10); count++;
      }
      return total; // 0..30
    }
  
    function renderProbBars(probs) {
      probBarsEl.innerHTML = '';
      labels.forEach((lbl, i) => {
        const pct = ((probs ? probs[i] : 0) * 100).toFixed(1);
        const wrap = document.createElement('div');
        wrap.style.marginBottom = '8px';
        wrap.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;"><span>${lbl}</span><span class="mono">${pct}%</span></div>`;
        const barWrap = document.createElement('div'); barWrap.className = 'barWrap';
        const bar = document.createElement('div'); bar.className = 'bar'; bar.style.width = pct + '%'; bar.style.background = i === 1 ? '#00d98b' : '#2f3a78';
        barWrap.appendChild(bar); wrap.appendChild(barWrap); probBarsEl.appendChild(wrap);
      });
    }
  
    function renderNormTable(st) {
      const rows = [];
      const aiZ = normalize(st.active_intensity, 'active_intensity');
      const slZ = normalize(st.sleep_per_week, 'sleep_per_week');
      const swZ = normalize(st.sumw, 'sumw');
      rows.push(['sex', sexMap[st.sex], '—']);
      rows.push(['active_intensity', st.active_intensity, aiZ.toFixed(4)]);
      rows.push(['sleep_per_week', st.sleep_per_week.toFixed(0), slZ.toFixed(4)]);
      rows.push(['sumw', st.sumw, swZ.toFixed(4)]);
      normBody.innerHTML = rows.map(r => `<tr><td>${r[0]}</td><td>${r[1]}</td><td class="mono">${r[2]}</td></tr>`).join('');
    }
  
    function updateSuggestion(st, pred){
  // Snapshot current
  curAI.textContent = st.active_intensity.toFixed(0);
  curSleep.textContent = Math.round(st.sleep_per_week).toString();
  curSumw.textContent = st.sumw.toString();

  // Always attempt to find a delta, even if it doesn't meet the target
  const found = searchEqualDelta(st, 0.7);

  // If the current prediction is already good, show that.
  if(pred.label === 'Normal' && pred.probs[1] >= 0.7){
    suggestNote.innerHTML = `<span class="badge ok">ปัจจุบันอยู่ในระดับปกติ (≥0.7)</span>`;
    sugAI.textContent = '—';
    sugSleep.textContent = '—';
    sugSumw.textContent = '—';
    return;
  }
  
  // Convert suggested z back to raw, clamp to valid ranges, round as specified
  const base = {
    aiZ: normalize(st.active_intensity,'active_intensity'),
    slZ: normalize(st.sleep_per_week,'sleep_per_week'),
    swZ: normalize(st.sumw,'sumw')
  };

  // If a valid delta was found, use it. Otherwise, assume a large delta to provide some suggestion.
  const delta = found.ok ? found.delta : (pred.probs[1] < 0.7 ? 5.0 : -5.0); // Use a default large delta if not found

  const aiRaw = clamp(Math.round(toRawFromZ(base.aiZ + delta, 'active_intensity')), 0, 4);
  const slRaw = clamp(Math.round(toRawFromZ(base.slZ + delta, 'sleep_per_week')), 0, 84);
  const swRaw = clamp(Math.round(toRawFromZ(base.swZ + delta, 'sumw')), 0, 30);

  // Re-evaluate achieved probability after rounding to discrete domains
  const stRounded = { ...st, active_intensity: aiRaw, sleep_per_week: slRaw, sumw: swRaw };
  const predRounded = predict(stRounded);

  sugAI.textContent = String(aiRaw);
  sugSleep.textContent = String(slRaw);
  sugSumw.textContent = String(swRaw);

  const pTarget = 0.7;
  const txt = (predRounded.probs[1] >= pTarget)
    ? `<span class="badge ok">Suggested achieves Normal ≥ 0.7</span>`
    : `<span class="badge bad">Rounded suggestion <em>does not</em> reach 0.7 (current: ${(predRounded.probs[1]*100).toFixed(1)}%)</span>`;
  
  // Note now always shows a delta, even if it's a default one
  suggestNote.innerHTML = `${txt} <span class="small">(Δ ≈ ${delta.toFixed(2)} SD equally on 3 features)</span>`;
}
  
    function renderAll() {
      if (!state) { renderProbBars([0, 0, 0]); return; }
      // BMI
      const { bmi, cls } = bmiAndClass(state.weight, state.height);
      bmiTextEl.textContent = `${bmi.toFixed(1)} (${cls})`;
  
      // Prediction
      const pred = predict(state);
      predLabelEl.textContent = `${pred.label}  [ ${pred.probs.map(p => p.toFixed(3)).join(' / ')} ]`;
  
      // Bars + Norm table
      renderProbBars(pred.probs);
      renderNormTable(state);
  
      // Suggestion
      suggestCard.classList.remove('hidden');
      updateSuggestion(state, pred);
    }
  
    function bindLive() {
      // Sleep slider updates
      adjSleep.addEventListener('input', () => {
        if (!state) return;
        state.sleep_per_week = Number(adjSleep.value);
        adjSleepVal.textContent = String(Math.round(state.sleep_per_week));
        renderAll();
      });
  
      sumwBody.addEventListener('change', () => {
        if (!state) return; 
        const s = readSumw();
        if (s != null) { state.sumw = s; renderAll(); }
      });
  
      document.addEventListener('change', (e) => {
        if (!state) return;
        if (e.target && e.target.name === 'activeIntensity') {
          state.active_intensity = Number(e.target.value);
          renderAll();
        }
      });
    }
  
    form.addEventListener('submit', (evt) => {
      evt.preventDefault();
      const sex = qs('#sex').value;
      const age = Number(17);
      const height = Number(qs('#height').value);
      const weight = Number(qs('#weight').value);
      const aiPicked = qs('input[name="activeIntensity"]:checked');
      if (!aiPicked) { alert('กรุณาเลือกระดับกิจกรรม'); return; }
      const active_intensity = Number(aiPicked.value);
  
      const sd = Number(qs('#sleepDays').value);
      const sh = Number(qs('#sleepHours').value);
      const sleep_per_week = clamp(Math.round(sleepPerWeekFrom(sd, sh)), 0, 84);
  
      const s = readSumw();
      if (s == null) { alert('กรุณาตอบแบบสอบถาม sumw ให้ครบทุกข้อ'); return; }
  
      state = { sex, age, height, weight, active_intensity, sleep_per_week, sumw: s };
  
      // Prep UI
adjustCard.classList.remove('hidden');
adjSleep.value = String(sleep_per_week);
adjSleepVal.textContent = String(sleep_per_week);
  
      renderAll();
    });
  
    function init() {
      generateSumwTable();
      renderProbBars([0, 0, 0]);
      bindLive();
    }
    init();
  </script>
</body>
</html>
